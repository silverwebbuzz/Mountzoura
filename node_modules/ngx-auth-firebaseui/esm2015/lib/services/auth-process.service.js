import { __awaiter, __decorate, __param } from "tslib";
import { EventEmitter, forwardRef, Inject, Injectable } from '@angular/core';
import { AngularFireAuth } from '@angular/fire/auth';
import { firebase } from '@firebase/app';
import '@firebase/auth';
import { BehaviorSubject } from 'rxjs';
import { map, take } from 'rxjs/operators';
import { Accounts } from '../enums';
import { FirestoreSyncService } from './firestore-sync.service';
import { MAT_SNACK_BAR_DEFAULT_OPTIONS, MatSnackBar, MatSnackBarConfig } from '@angular/material/snack-bar';
import { NgxAuthFirebaseUIConfigToken } from '../tokens';
import * as i0 from "@angular/core";
import * as i1 from "@angular/fire/auth";
import * as i2 from "../tokens/index";
import * as i3 from "@angular/material/snack-bar";
import * as i4 from "./firestore-sync.service";
export const facebookAuthProvider = new firebase.auth.FacebookAuthProvider();
export const googleAuthProvider = new firebase.auth.GoogleAuthProvider();
export const appleAuthProvider = new firebase.auth.OAuthProvider('apple.com');
export const twitterAuthProvider = new firebase.auth.TwitterAuthProvider();
export const githubAuthProvider = new firebase.auth.GithubAuthProvider();
export const microsoftAuthProvider = new firebase.auth.OAuthProvider('microsoft.com');
export const yahooAuthProvider = new firebase.auth.OAuthProvider('yahoo.com');
export var AuthProvider;
(function (AuthProvider) {
    AuthProvider["ALL"] = "all";
    AuthProvider["ANONYMOUS"] = "anonymous";
    AuthProvider["EmailAndPassword"] = "firebase";
    AuthProvider["Google"] = "google";
    AuthProvider["Apple"] = "apple";
    AuthProvider["Facebook"] = "facebook";
    AuthProvider["Twitter"] = "twitter";
    AuthProvider["Github"] = "github";
    AuthProvider["Microsoft"] = "microsoft";
    AuthProvider["Yahoo"] = "yahoo";
    AuthProvider["PhoneNumber"] = "phoneNumber";
})(AuthProvider || (AuthProvider = {}));
let AuthProcessService = class AuthProcessService {
    constructor(afa, config, snackBar, fireStoreService, matSnackBarConfig) {
        this.afa = afa;
        this.config = config;
        this.snackBar = snackBar;
        this.fireStoreService = fireStoreService;
        this.matSnackBarConfig = matSnackBarConfig;
        this.onSuccessEmitter = new EventEmitter();
        this.onErrorEmitter = new EventEmitter();
        // Useful to know about auth state even between reloads.
        // Replace emailConfirmationSent and emailToConfirm.
        this._user$ = new BehaviorSubject(null);
    }
    get user$() {
        return this._user$.asObservable();
    }
    listenToUserEvents() {
        this.afa.user.subscribe((user) => {
            this._user$.next(user);
            this.user = user;
        });
    }
    /**
     * Reset the password of the ngx-auth-firebaseui-user via email
     *
     * @param email - the email to reset
     */
    resetPassword(email) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                console.log('Password reset email sent');
                return yield this.afa.sendPasswordResetEmail(email);
            }
            catch (error) {
                return this.notifyError(error);
            }
        });
    }
    /**
     * General sign in mechanism to authenticate the users with a firebase project
     * using a traditional way, via username and password or by using an authentication provider
     * like google, facebook, twitter and github
     *
     * @param provider - the provider to authenticate with (google, facebook, twitter, github)
     * @param credentials optional email and password
     */
    signInWith(provider, credentials) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                let signInResult;
                switch (provider) {
                    case AuthProvider.ANONYMOUS:
                        signInResult = (yield this.afa.signInAnonymously());
                        break;
                    case AuthProvider.EmailAndPassword:
                        signInResult = (yield this.afa.signInWithEmailAndPassword(credentials.email, credentials.password));
                        break;
                    case AuthProvider.Google:
                        signInResult = (yield this.afa.signInWithPopup(googleAuthProvider));
                        break;
                    case AuthProvider.Apple:
                        signInResult = (yield this.afa.signInWithPopup(appleAuthProvider));
                        break;
                    case AuthProvider.Facebook:
                        signInResult = (yield this.afa.signInWithPopup(facebookAuthProvider));
                        break;
                    case AuthProvider.Twitter:
                        signInResult = (yield this.afa.signInWithPopup(twitterAuthProvider));
                        break;
                    case AuthProvider.Github:
                        signInResult = (yield this.afa.signInWithPopup(githubAuthProvider));
                        break;
                    case AuthProvider.Microsoft:
                        signInResult = (yield this.afa.signInWithPopup(microsoftAuthProvider));
                        break;
                    case AuthProvider.Yahoo:
                        signInResult = (yield this.afa.signInWithPopup(yahooAuthProvider));
                        break;
                    case AuthProvider.PhoneNumber:
                        // coming soon - see feature/sms branch
                        break;
                    default:
                        throw new Error(`${AuthProvider[provider]} is not available as auth provider`);
                }
                yield this.handleSuccess(signInResult);
            }
            catch (err) {
                this.handleError(err);
            }
        });
    }
    /**
     * Sign up new users via email and password.
     * After that the ngx-auth-firebaseui-user should verify and confirm an email sent via the firebase
     *
     * @param displayName - the displayName if the new ngx-auth-firebaseui-user
     * @param credentials email and password
     * @returns -
     */
    signUp(displayName, credentials) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const userCredential = yield this.afa.createUserWithEmailAndPassword(credentials.email, credentials.password);
                const user = userCredential.user;
                yield this.updateProfile(displayName, user.photoURL);
                if (this.config.enableFirestoreSync) {
                    yield this.fireStoreService
                        .getUserDocRefByUID(user.uid)
                        .set({
                        uid: user.uid,
                        displayName,
                        email: user.email,
                        photoURL: user.photoURL
                    });
                }
                if (this.config.enableEmailVerification) {
                    yield user.sendEmailVerification();
                }
                // Legacy fields
                this.emailConfirmationSent = true;
                this.emailToConfirm = credentials.email;
                yield this.handleSuccess(userCredential);
            }
            catch (err) {
                this.handleError(err);
            }
        });
    }
    sendNewVerificationEmail() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.user) {
                return Promise.reject(new Error('No signed in user'));
            }
            return this.user.sendEmailVerification();
        });
    }
    signOut() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.afa.signOut();
            }
            catch (error) {
                this.notifyError(error);
            }
        });
    }
    /**
     * Update the profile (name + photo url) of the authenticated ngx-auth-firebaseui-user in the
     * firebase authentication feature (not in firestore)
     *
     * @param name - the new name of the authenticated ngx-auth-firebaseui-user
     * @param photoURL - the new photo url of the authenticated ngx-auth-firebaseui-user
     * @returns -
     */
    updateProfile(name, photoURL) {
        return this.afa.currentUser.then((user) => {
            if (!photoURL) {
                return user.updateProfile({ displayName: name });
            }
            else {
                return user.updateProfile({ displayName: name, photoURL });
            }
        });
    }
    parseUserInfo(user) {
        return {
            uid: user.uid,
            displayName: user.displayName,
            email: user.email,
            phoneNumber: user.phoneNumber,
            photoURL: user.photoURL,
            providerId: user.providerData.length > 0 ? user.providerData[0].providerId : null
        };
    }
    getUserPhotoUrl() {
        return this._user$.pipe(map((user) => {
            if (!user) {
                return null;
            }
            else if (user.photoURL) {
                return user.photoURL;
            }
            else if (user.emailVerified) {
                return this.getPhotoPath(Accounts.CHECK);
            }
            else if (user.isAnonymous) {
                return this.getPhotoPath(Accounts.OFF);
            }
            else {
                return this.getPhotoPath(Accounts.NONE);
            }
        }));
    }
    getPhotoPath(image) {
        return `assets/user/${image}.svg`;
    }
    signInWithPhoneNumber() {
        // todo: 3.1.18
    }
    handleSuccess(userCredential) {
        return __awaiter(this, void 0, void 0, function* () {
            this.onSuccessEmitter.next(userCredential.user);
            if (this.config.enableFirestoreSync) {
                try {
                    yield this.fireStoreService.updateUserData(this.parseUserInfo(userCredential.user));
                }
                catch (e) {
                    console.error(`Error occurred while updating user data with firestore: ${e}`);
                }
            }
            if (this.config.toastMessageOnAuthSuccess) {
                const fallbackMessage = `Hello ${userCredential.user.displayName ? userCredential.user.displayName : ''}!`;
                this.showToast(this.messageOnAuthSuccess || fallbackMessage);
            }
        });
    }
    handleError(error) {
        this.notifyError(error);
        console.error(error);
    }
    // Refresh user info. Can be useful for instance to get latest status regarding email verification.
    reloadUserInfo() {
        return this._user$.pipe(take(1)).subscribe((user) => user && user.reload());
    }
    // Search for an error message.
    // Consumers of this library are given the possibility to provide a
    // function in case they want to instrument message based on error properties.
    getMessageOnAuthError(error) {
        // tslint:disable-next-line:no-bitwise
        return error.toString() || 'Sorry, something went wrong. Please retry later.';
    }
    // Show a toast using current snackbar config. If message is empty, no toast is displayed allowing to opt-out when needed.
    // Default MatSnackBarConfig has no duration, meaning it stays visible forever.
    // If that's the case, an action button is added to allow the end-user to dismiss the toast.
    showToast(message) {
        if (message) {
            this.snackBar.open(message, this.matSnackBarConfig.duration ? null : 'OK');
        }
    }
    showErrorToast(error) {
        if (this.config.toastMessageOnAuthError) {
            this.showToast(this.getMessageOnAuthError(error));
        }
    }
    notifyError(error) {
        this.onErrorEmitter.emit(error);
        this.showErrorToast(error);
    }
};
AuthProcessService.ctorParameters = () => [
    { type: AngularFireAuth },
    { type: undefined, decorators: [{ type: Inject, args: [forwardRef(() => NgxAuthFirebaseUIConfigToken),] }] },
    { type: MatSnackBar },
    { type: FirestoreSyncService },
    { type: MatSnackBarConfig, decorators: [{ type: Inject, args: [MAT_SNACK_BAR_DEFAULT_OPTIONS,] }] }
];
AuthProcessService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AuthProcessService_Factory() { return new AuthProcessService(i0.ɵɵinject(i1.AngularFireAuth), i0.ɵɵinject(i2.NgxAuthFirebaseUIConfigToken), i0.ɵɵinject(i3.MatSnackBar), i0.ɵɵinject(i4.FirestoreSyncService), i0.ɵɵinject(i3.MAT_SNACK_BAR_DEFAULT_OPTIONS)); }, token: AuthProcessService, providedIn: "root" });
AuthProcessService = __decorate([
    Injectable({
        providedIn: 'root'
    }),
    __param(1, Inject(forwardRef(() => NgxAuthFirebaseUIConfigToken))),
    __param(4, Inject(MAT_SNACK_BAR_DEFAULT_OPTIONS))
], AuthProcessService);
export { AuthProcessService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1wcm9jZXNzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtYXV0aC1maXJlYmFzZXVpLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2F1dGgtcHJvY2Vzcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sZ0JBQWdCLENBQUM7QUFFeEIsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDcEMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsT0FBTyxFQUFFLDZCQUE2QixFQUFFLFdBQVcsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTVHLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLFdBQVcsQ0FBQzs7Ozs7O0FBR3pELE1BQU0sQ0FBQyxNQUFNLG9CQUFvQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0FBQzdFLE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0FBQ3pFLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDOUUsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcs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bWl0dGVyLCBmb3J3YXJkUmVmLCBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFuZ3VsYXJGaXJlQXV0aCB9IGZyb20gJ0Bhbmd1bGFyL2ZpcmUvYXV0aCc7XG5pbXBvcnQgeyBmaXJlYmFzZSB9IGZyb20gJ0BmaXJlYmFzZS9hcHAnO1xuaW1wb3J0ICdAZmlyZWJhc2UvYXV0aCc7XG5pbXBvcnQgeyBVc2VyLCBVc2VySW5mbyB9IGZyb20gJ2ZpcmViYXNlL2FwcCc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFjY291bnRzIH0gZnJvbSAnLi4vZW51bXMnO1xuaW1wb3J0IHsgRmlyZXN0b3JlU3luY1NlcnZpY2UgfSBmcm9tICcuL2ZpcmVzdG9yZS1zeW5jLnNlcnZpY2UnO1xuaW1wb3J0IHsgTUFUX1NOQUNLX0JBUl9ERUZBVUxUX09QVElPTlMsIE1hdFNuYWNrQmFyLCBNYXRTbmFja0JhckNvbmZpZyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3NuYWNrLWJhcic7XG5pbXBvcnQgeyBJQ3JlZGVudGlhbHMsIElTaWduSW5Qcm9jZXNzLCBJU2lnblVwUHJvY2VzcywgTmd4QXV0aEZpcmViYXNlVUlDb25maWcgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IE5neEF1dGhGaXJlYmFzZVVJQ29uZmlnVG9rZW4gfSBmcm9tICcuLi90b2tlbnMnO1xuaW1wb3J0IFVzZXJDcmVkZW50aWFsID0gZmlyZWJhc2UuYXV0aC5Vc2VyQ3JlZGVudGlhbDtcblxuZXhwb3J0IGNvbnN0IGZhY2Vib29rQXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguRmFjZWJvb2tBdXRoUHJvdmlkZXIoKTtcbmV4cG9ydCBjb25zdCBnb29nbGVBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5Hb29nbGVBdXRoUHJvdmlkZXIoKTtcbmV4cG9ydCBjb25zdCBhcHBsZUF1dGhQcm92aWRlciA9IG5ldyBmaXJlYmFzZS5hdXRoLk9BdXRoUHJvdmlkZXIoJ2FwcGxlLmNvbScpO1xuZXhwb3J0IGNvbnN0IHR3aXR0ZXJBdXRoUHJvdmlkZXIgPSBuZXcgZmlyZWJhc2UuYXV0aC5Ud2l0dGVyQXV0aFByb3ZpZGVyKCk7XG5leHBvcnQgY29uc3QgZ2l0aHViQXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguR2l0aHViQXV0aFByb3ZpZGVyKCk7XG5leHBvcnQgY29uc3QgbWljcm9zb2Z0QXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguT0F1dGhQcm92aWRlcignbWljcm9zb2Z0LmNvbScpO1xuZXhwb3J0IGNvbnN0IHlhaG9vQXV0aFByb3ZpZGVyID0gbmV3IGZpcmViYXNlLmF1dGguT0F1dGhQcm92aWRlcigneWFob28uY29tJyk7XG5cbmV4cG9ydCBlbnVtIEF1dGhQcm92aWRlciB7XG4gIEFMTCA9ICdhbGwnLFxuICBBTk9OWU1PVVMgPSAnYW5vbnltb3VzJyxcbiAgRW1haWxBbmRQYXNzd29yZCA9ICdmaXJlYmFzZScsXG4gIEdvb2dsZSA9ICdnb29nbGUnLFxuICBBcHBsZSA9ICdhcHBsZScsXG4gIEZhY2Vib29rID0gJ2ZhY2Vib29rJyxcbiAgVHdpdHRlciA9ICd0d2l0dGVyJyxcbiAgR2l0aHViID0gJ2dpdGh1YicsXG4gIE1pY3Jvc29mdCA9ICdtaWNyb3NvZnQnLFxuICBZYWhvbyA9ICd5YWhvbycsXG4gIFBob25lTnVtYmVyID0gJ3Bob25lTnVtYmVyJ1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBdXRoUHJvY2Vzc1NlcnZpY2UgaW1wbGVtZW50cyBJU2lnbkluUHJvY2VzcywgSVNpZ25VcFByb2Nlc3Mge1xuICBvblN1Y2Nlc3NFbWl0dGVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBvbkVycm9yRW1pdHRlcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAvLyBVc2VmdWwgdG8ga25vdyBhYm91dCBhdXRoIHN0YXRlIGV2ZW4gYmV0d2VlbiByZWxvYWRzLlxuICAvLyBSZXBsYWNlIGVtYWlsQ29uZmlybWF0aW9uU2VudCBhbmQgZW1haWxUb0NvbmZpcm0uXG4gIHByaXZhdGUgX3VzZXIkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxmaXJlYmFzZS5Vc2VyIHwgbnVsbD4obnVsbCk7XG4gIGdldCB1c2VyJCgpOiBPYnNlcnZhYmxlPGZpcmViYXNlLlVzZXIgfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuX3VzZXIkLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIGFjY2VzcyB2aWEgdXNlciQgYXN5bmNocm9ub3VzbHkgaW5zdGVhZFxuICAgKi9cbiAgdXNlcjogVXNlcjtcblxuICBtZXNzYWdlT25BdXRoU3VjY2Vzczogc3RyaW5nO1xuICBtZXNzYWdlT25BdXRoRXJyb3I6IHN0cmluZztcblxuICAvLyBMZWdhY3kgZmllbGQgdGhhdCBpcyBzZXQgdG8gdHJ1ZSBhZnRlciBzaWduIHVwLlxuICAvLyBWYWx1ZSBpcyBsb3N0IGluIGNhc2Ugb2YgcmVsb2FkLiBUaGUgaWRlYSBoZXJlIGlzIHRvIGtub3cgaWYgd2UganVzdCBzZW50IGEgdmVyaWZpY2F0aW9uIGVtYWlsLlxuICBlbWFpbENvbmZpcm1hdGlvblNlbnQ6IGJvb2xlYW47XG4gIC8vIExlZ2FjeSBmaWxlZCB0aGF0IGNvbnRhaW4gdGhlIG1haWwgdG8gY29uZmlybS4gU2FtZSBsaWZlY3ljbGUgdGhhbiBlbWFpbENvbmZpcm1hdGlvblNlbnQuXG4gIGVtYWlsVG9Db25maXJtOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGFmYTogQW5ndWxhckZpcmVBdXRoLFxuICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBOZ3hBdXRoRmlyZWJhc2VVSUNvbmZpZ1Rva2VuKSkgcHVibGljIGNvbmZpZzogTmd4QXV0aEZpcmViYXNlVUlDb25maWcsXG4gICAgcHJpdmF0ZSBzbmFja0JhcjogTWF0U25hY2tCYXIsXG4gICAgcHJpdmF0ZSBmaXJlU3RvcmVTZXJ2aWNlOiBGaXJlc3RvcmVTeW5jU2VydmljZSxcbiAgICBASW5qZWN0KE1BVF9TTkFDS19CQVJfREVGQVVMVF9PUFRJT05TKSBwcml2YXRlIG1hdFNuYWNrQmFyQ29uZmlnOiBNYXRTbmFja0JhckNvbmZpZ1xuICApIHtcbiAgfVxuXG4gIGxpc3RlblRvVXNlckV2ZW50cygpIHtcbiAgICB0aGlzLmFmYS51c2VyLnN1YnNjcmliZSgodXNlcjogZmlyZWJhc2UuVXNlciB8IG51bGwpID0+IHtcbiAgICAgIHRoaXMuX3VzZXIkLm5leHQodXNlcik7XG4gICAgICB0aGlzLnVzZXIgPSB1c2VyO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IHRoZSBwYXNzd29yZCBvZiB0aGUgbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyIHZpYSBlbWFpbFxuICAgKlxuICAgKiBAcGFyYW0gZW1haWwgLSB0aGUgZW1haWwgdG8gcmVzZXRcbiAgICovXG4gIHB1YmxpYyBhc3luYyByZXNldFBhc3N3b3JkKGVtYWlsOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc29sZS5sb2coJ1Bhc3N3b3JkIHJlc2V0IGVtYWlsIHNlbnQnKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmFmYS5zZW5kUGFzc3dvcmRSZXNldEVtYWlsKGVtYWlsKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHRoaXMubm90aWZ5RXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmFsIHNpZ24gaW4gbWVjaGFuaXNtIHRvIGF1dGhlbnRpY2F0ZSB0aGUgdXNlcnMgd2l0aCBhIGZpcmViYXNlIHByb2plY3RcbiAgICogdXNpbmcgYSB0cmFkaXRpb25hbCB3YXksIHZpYSB1c2VybmFtZSBhbmQgcGFzc3dvcmQgb3IgYnkgdXNpbmcgYW4gYXV0aGVudGljYXRpb24gcHJvdmlkZXJcbiAgICogbGlrZSBnb29nbGUsIGZhY2Vib29rLCB0d2l0dGVyIGFuZCBnaXRodWJcbiAgICpcbiAgICogQHBhcmFtIHByb3ZpZGVyIC0gdGhlIHByb3ZpZGVyIHRvIGF1dGhlbnRpY2F0ZSB3aXRoIChnb29nbGUsIGZhY2Vib29rLCB0d2l0dGVyLCBnaXRodWIpXG4gICAqIEBwYXJhbSBjcmVkZW50aWFscyBvcHRpb25hbCBlbWFpbCBhbmQgcGFzc3dvcmRcbiAgICovXG4gIHB1YmxpYyBhc3luYyBzaWduSW5XaXRoKHByb3ZpZGVyOiBBdXRoUHJvdmlkZXIsIGNyZWRlbnRpYWxzPzogSUNyZWRlbnRpYWxzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBzaWduSW5SZXN1bHQ6IFVzZXJDcmVkZW50aWFsIHwgYW55O1xuXG4gICAgICBzd2l0Y2ggKHByb3ZpZGVyKSB7XG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLkFOT05ZTU9VUzpcbiAgICAgICAgICBzaWduSW5SZXN1bHQgPSBhd2FpdCB0aGlzLmFmYS5zaWduSW5Bbm9ueW1vdXNseSgpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLkVtYWlsQW5kUGFzc3dvcmQ6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aEVtYWlsQW5kUGFzc3dvcmQoY3JlZGVudGlhbHMuZW1haWwsIGNyZWRlbnRpYWxzLnBhc3N3b3JkKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5Hb29nbGU6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKGdvb2dsZUF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuQXBwbGU6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKGFwcGxlQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5GYWNlYm9vazpcbiAgICAgICAgICBzaWduSW5SZXN1bHQgPSBhd2FpdCB0aGlzLmFmYS5zaWduSW5XaXRoUG9wdXAoZmFjZWJvb2tBdXRoUHJvdmlkZXIpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLlR3aXR0ZXI6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKHR3aXR0ZXJBdXRoUHJvdmlkZXIpIGFzIFVzZXJDcmVkZW50aWFsO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgQXV0aFByb3ZpZGVyLkdpdGh1YjpcbiAgICAgICAgICBzaWduSW5SZXN1bHQgPSBhd2FpdCB0aGlzLmFmYS5zaWduSW5XaXRoUG9wdXAoZ2l0aHViQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5NaWNyb3NvZnQ6XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKG1pY3Jvc29mdEF1dGhQcm92aWRlcikgYXMgVXNlckNyZWRlbnRpYWw7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBBdXRoUHJvdmlkZXIuWWFob286XG4gICAgICAgICAgc2lnbkluUmVzdWx0ID0gYXdhaXQgdGhpcy5hZmEuc2lnbkluV2l0aFBvcHVwKHlhaG9vQXV0aFByb3ZpZGVyKSBhcyBVc2VyQ3JlZGVudGlhbDtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIEF1dGhQcm92aWRlci5QaG9uZU51bWJlcjpcbiAgICAgICAgICAvLyBjb21pbmcgc29vbiAtIHNlZSBmZWF0dXJlL3NtcyBicmFuY2hcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtBdXRoUHJvdmlkZXJbcHJvdmlkZXJdfSBpcyBub3QgYXZhaWxhYmxlIGFzIGF1dGggcHJvdmlkZXJgKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3VjY2VzcyhzaWduSW5SZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnIpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTaWduIHVwIG5ldyB1c2VycyB2aWEgZW1haWwgYW5kIHBhc3N3b3JkLlxuICAgKiBBZnRlciB0aGF0IHRoZSBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXIgc2hvdWxkIHZlcmlmeSBhbmQgY29uZmlybSBhbiBlbWFpbCBzZW50IHZpYSB0aGUgZmlyZWJhc2VcbiAgICpcbiAgICogQHBhcmFtIGRpc3BsYXlOYW1lIC0gdGhlIGRpc3BsYXlOYW1lIGlmIHRoZSBuZXcgbmd4LWF1dGgtZmlyZWJhc2V1aS11c2VyXG4gICAqIEBwYXJhbSBjcmVkZW50aWFscyBlbWFpbCBhbmQgcGFzc3dvcmRcbiAgICogQHJldHVybnMgLVxuICAgKi9cbiAgcHVibGljIGFzeW5jIHNpZ25VcChkaXNwbGF5TmFtZTogc3RyaW5nLCBjcmVkZW50aWFsczogSUNyZWRlbnRpYWxzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXJDcmVkZW50aWFsOiBVc2VyQ3JlZGVudGlhbCA9IGF3YWl0IHRoaXMuYWZhLmNyZWF0ZVVzZXJXaXRoRW1haWxBbmRQYXNzd29yZChjcmVkZW50aWFscy5lbWFpbCwgY3JlZGVudGlhbHMucGFzc3dvcmQpO1xuICAgICAgY29uc3QgdXNlciA9IHVzZXJDcmVkZW50aWFsLnVzZXI7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZVByb2ZpbGUoZGlzcGxheU5hbWUsIHVzZXIucGhvdG9VUkwpO1xuXG4gICAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlRmlyZXN0b3JlU3luYykge1xuICAgICAgICBhd2FpdCB0aGlzLmZpcmVTdG9yZVNlcnZpY2VcbiAgICAgICAgICAuZ2V0VXNlckRvY1JlZkJ5VUlEKHVzZXIudWlkKVxuICAgICAgICAgIC5zZXQoe1xuICAgICAgICAgICAgdWlkOiB1c2VyLnVpZCxcbiAgICAgICAgICAgIGRpc3BsYXlOYW1lLFxuICAgICAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgICAgICBwaG90b1VSTDogdXNlci5waG90b1VSTFxuICAgICAgICAgIH0gYXMgVXNlcik7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVFbWFpbFZlcmlmaWNhdGlvbikge1xuICAgICAgICBhd2FpdCB1c2VyLnNlbmRFbWFpbFZlcmlmaWNhdGlvbigpO1xuICAgICAgfVxuXG4gICAgICAvLyBMZWdhY3kgZmllbGRzXG4gICAgICB0aGlzLmVtYWlsQ29uZmlybWF0aW9uU2VudCA9IHRydWU7XG4gICAgICB0aGlzLmVtYWlsVG9Db25maXJtID0gY3JlZGVudGlhbHMuZW1haWw7XG5cbiAgICAgIGF3YWl0IHRoaXMuaGFuZGxlU3VjY2Vzcyh1c2VyQ3JlZGVudGlhbCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLmhhbmRsZUVycm9yKGVycik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZE5ld1ZlcmlmaWNhdGlvbkVtYWlsKCk6IFByb21pc2U8dm9pZCB8IG5ldmVyPiB7XG4gICAgaWYgKCF0aGlzLnVzZXIpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoJ05vIHNpZ25lZCBpbiB1c2VyJykpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy51c2VyLnNlbmRFbWFpbFZlcmlmaWNhdGlvbigpO1xuICB9XG5cbiAgYXN5bmMgc2lnbk91dCgpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZmEuc2lnbk91dCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLm5vdGlmeUVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHRoZSBwcm9maWxlIChuYW1lICsgcGhvdG8gdXJsKSBvZiB0aGUgYXV0aGVudGljYXRlZCBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXIgaW4gdGhlXG4gICAqIGZpcmViYXNlIGF1dGhlbnRpY2F0aW9uIGZlYXR1cmUgKG5vdCBpbiBmaXJlc3RvcmUpXG4gICAqXG4gICAqIEBwYXJhbSBuYW1lIC0gdGhlIG5ldyBuYW1lIG9mIHRoZSBhdXRoZW50aWNhdGVkIG5neC1hdXRoLWZpcmViYXNldWktdXNlclxuICAgKiBAcGFyYW0gcGhvdG9VUkwgLSB0aGUgbmV3IHBob3RvIHVybCBvZiB0aGUgYXV0aGVudGljYXRlZCBuZ3gtYXV0aC1maXJlYmFzZXVpLXVzZXJcbiAgICogQHJldHVybnMgLVxuICAgKi9cbiAgcHVibGljIHVwZGF0ZVByb2ZpbGUobmFtZTogc3RyaW5nLCBwaG90b1VSTDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuYWZhLmN1cnJlbnRVc2VyLnRoZW4oKHVzZXI6IFVzZXIpID0+IHtcbiAgICAgIGlmICghcGhvdG9VUkwpIHtcbiAgICAgICAgcmV0dXJuIHVzZXIudXBkYXRlUHJvZmlsZSh7ZGlzcGxheU5hbWU6IG5hbWV9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB1c2VyLnVwZGF0ZVByb2ZpbGUoe2Rpc3BsYXlOYW1lOiBuYW1lLCBwaG90b1VSTH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHBhcnNlVXNlckluZm8odXNlcjogVXNlcik6IFVzZXJJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgdWlkOiB1c2VyLnVpZCxcbiAgICAgIGRpc3BsYXlOYW1lOiB1c2VyLmRpc3BsYXlOYW1lLFxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICBwaG9uZU51bWJlcjogdXNlci5waG9uZU51bWJlcixcbiAgICAgIHBob3RvVVJMOiB1c2VyLnBob3RvVVJMLFxuICAgICAgcHJvdmlkZXJJZDogdXNlci5wcm92aWRlckRhdGEubGVuZ3RoID4gMCA/IHVzZXIucHJvdmlkZXJEYXRhWzBdLnByb3ZpZGVySWQgOiBudWxsXG4gICAgfTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRVc2VyUGhvdG9VcmwoKTogT2JzZXJ2YWJsZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgcmV0dXJuIHRoaXMuX3VzZXIkLnBpcGUoXG4gICAgICBtYXAoKHVzZXI6IGZpcmViYXNlLlVzZXIgfCBudWxsKSA9PiB7XG4gICAgICAgIGlmICghdXNlcikge1xuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9IGVsc2UgaWYgKHVzZXIucGhvdG9VUkwpIHtcbiAgICAgICAgICByZXR1cm4gdXNlci5waG90b1VSTDtcbiAgICAgICAgfSBlbHNlIGlmICh1c2VyLmVtYWlsVmVyaWZpZWQpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRQaG90b1BhdGgoQWNjb3VudHMuQ0hFQ0spO1xuICAgICAgICB9IGVsc2UgaWYgKHVzZXIuaXNBbm9ueW1vdXMpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRQaG90b1BhdGgoQWNjb3VudHMuT0ZGKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRQaG90b1BhdGgoQWNjb3VudHMuTk9ORSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRQaG90b1BhdGgoaW1hZ2U6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBhc3NldHMvdXNlci8ke2ltYWdlfS5zdmdgO1xuICB9XG5cbiAgcHVibGljIHNpZ25JbldpdGhQaG9uZU51bWJlcigpIHtcbiAgICAvLyB0b2RvOiAzLjEuMThcbiAgfVxuXG4gIGFzeW5jIGhhbmRsZVN1Y2Nlc3ModXNlckNyZWRlbnRpYWw6IFVzZXJDcmVkZW50aWFsKSB7XG4gICAgdGhpcy5vblN1Y2Nlc3NFbWl0dGVyLm5leHQodXNlckNyZWRlbnRpYWwudXNlcik7XG4gICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUZpcmVzdG9yZVN5bmMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZmlyZVN0b3JlU2VydmljZS51cGRhdGVVc2VyRGF0YSh0aGlzLnBhcnNlVXNlckluZm8odXNlckNyZWRlbnRpYWwudXNlcikpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBvY2N1cnJlZCB3aGlsZSB1cGRhdGluZyB1c2VyIGRhdGEgd2l0aCBmaXJlc3RvcmU6ICR7ZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRoaXMuY29uZmlnLnRvYXN0TWVzc2FnZU9uQXV0aFN1Y2Nlc3MpIHtcbiAgICAgIGNvbnN0IGZhbGxiYWNrTWVzc2FnZSA9IGBIZWxsbyAke3VzZXJDcmVkZW50aWFsLnVzZXIuZGlzcGxheU5hbWUgPyB1c2VyQ3JlZGVudGlhbC51c2VyLmRpc3BsYXlOYW1lIDogJyd9IWA7XG4gICAgICB0aGlzLnNob3dUb2FzdCh0aGlzLm1lc3NhZ2VPbkF1dGhTdWNjZXNzIHx8IGZhbGxiYWNrTWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSkge1xuICAgIHRoaXMubm90aWZ5RXJyb3IoZXJyb3IpO1xuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICB9XG5cbiAgLy8gUmVmcmVzaCB1c2VyIGluZm8uIENhbiBiZSB1c2VmdWwgZm9yIGluc3RhbmNlIHRvIGdldCBsYXRlc3Qgc3RhdHVzIHJlZ2FyZGluZyBlbWFpbCB2ZXJpZmljYXRpb24uXG4gIHJlbG9hZFVzZXJJbmZvKCkge1xuICAgIHJldHVybiB0aGlzLl91c2VyJC5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgodXNlcjogVXNlciB8IG51bGwpID0+IHVzZXIgJiYgdXNlci5yZWxvYWQoKSk7XG4gIH1cblxuICAvLyBTZWFyY2ggZm9yIGFuIGVycm9yIG1lc3NhZ2UuXG4gIC8vIENvbnN1bWVycyBvZiB0aGlzIGxpYnJhcnkgYXJlIGdpdmVuIHRoZSBwb3NzaWJpbGl0eSB0byBwcm92aWRlIGFcbiAgLy8gZnVuY3Rpb24gaW4gY2FzZSB0aGV5IHdhbnQgdG8gaW5zdHJ1bWVudCBtZXNzYWdlIGJhc2VkIG9uIGVycm9yIHByb3BlcnRpZXMuXG4gIGdldE1lc3NhZ2VPbkF1dGhFcnJvcihlcnJvcjogYW55KSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWJpdHdpc2VcbiAgICByZXR1cm4gZXJyb3IudG9TdHJpbmcoKSB8fCAnU29ycnksIHNvbWV0aGluZyB3ZW50IHdyb25nLiBQbGVhc2UgcmV0cnkgbGF0ZXIuJztcbiAgfVxuXG4gIC8vIFNob3cgYSB0b2FzdCB1c2luZyBjdXJyZW50IHNuYWNrYmFyIGNvbmZpZy4gSWYgbWVzc2FnZSBpcyBlbXB0eSwgbm8gdG9hc3QgaXMgZGlzcGxheWVkIGFsbG93aW5nIHRvIG9wdC1vdXQgd2hlbiBuZWVkZWQuXG4gIC8vIERlZmF1bHQgTWF0U25hY2tCYXJDb25maWcgaGFzIG5vIGR1cmF0aW9uLCBtZWFuaW5nIGl0IHN0YXlzIHZpc2libGUgZm9yZXZlci5cbiAgLy8gSWYgdGhhdCdzIHRoZSBjYXNlLCBhbiBhY3Rpb24gYnV0dG9uIGlzIGFkZGVkIHRvIGFsbG93IHRoZSBlbmQtdXNlciB0byBkaXNtaXNzIHRoZSB0b2FzdC5cbiAgc2hvd1RvYXN0KG1lc3NhZ2U6IHN0cmluZykge1xuICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICB0aGlzLnNuYWNrQmFyLm9wZW4obWVzc2FnZSwgdGhpcy5tYXRTbmFja0JhckNvbmZpZy5kdXJhdGlvbiA/IG51bGwgOiAnT0snKTtcbiAgICB9XG4gIH1cblxuICBzaG93RXJyb3JUb2FzdChlcnJvcjogYW55KSB7XG4gICAgaWYgKHRoaXMuY29uZmlnLnRvYXN0TWVzc2FnZU9uQXV0aEVycm9yKSB7XG4gICAgICB0aGlzLnNob3dUb2FzdCh0aGlzLmdldE1lc3NhZ2VPbkF1dGhFcnJvcihlcnJvcikpO1xuICAgIH1cbiAgfVxuXG4gIG5vdGlmeUVycm9yKGVycm9yOiBhbnkpIHtcbiAgICB0aGlzLm9uRXJyb3JFbWl0dGVyLmVtaXQoZXJyb3IpO1xuICAgIHRoaXMuc2hvd0Vycm9yVG9hc3QoZXJyb3IpO1xuICB9XG5cbn1cbiJdfQ==